<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot DDD</title>

  <!-- Markdown parser + Sanitizer (sin dependencias en Python) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <style>
    :root{
      --primary:#667eea;
      --primary-2:#5a6fd8;
      --bubble:#f7f7fb;
    }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      margin:0; padding:20px;
      min-height:100vh;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    .chat-container{
      max-width:700px; margin:0 auto; background:#fff;
      border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,.18); overflow:hidden;
    }
    .header{
      position:relative; background:var(--primary); color:#fff; padding:16px 56px 16px 16px; text-align:center;
    }
    .header h1{ margin:0; font-size:20px; }
    .reset-button{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      background:rgba(255,255,255,.18); border:none; color:#fff;
      padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px;
    }
    .reset-button:hover{ background:rgba(255,255,255,.28); }

    .messages{ height:460px; overflow-y:auto; padding:18px; background:#fafafe; }
    .message{
      margin:10px 0; padding:12px 14px; border-radius:12px; max-width:85%;
      line-height:1.5; word-wrap:break-word;
    }
    .user-message{ margin-left:auto; color:#fff; background:var(--primary); }
    .bot-message{ background:var(--bubble); color:#222; }

    /* Render Markdown bonito */
    .bot-message h1,.bot-message h2,.bot-message h3{ margin:0.4rem 0 0.3rem; }
    .bot-message p{ margin:0.4rem 0; }
    .bot-message strong{ font-weight:700; }
    .bot-message em{ font-style:italic; }
    .bot-message code{ background:#eee; padding:0 .25rem; border-radius:4px; }
    .bot-message pre{ background:#eee; padding:10px; border-radius:8px; overflow:auto; }
    .bot-message ul,.bot-message ol{ margin:0.25rem 0 0.25rem 1.2rem; padding:0; }
    .bot-message li{ margin:0.25rem 0; }  /* <-- cada item en su renglón */

    .input-area{ padding:14px; border-top:1px solid #eee; display:flex; gap:10px; background:#fff; }
    #messageInput{
      flex:1; padding:12px; border:1px solid #ddd; border-radius:10px; outline:none;
      background:#fff;
    }
    #sendButton{
      padding:12px 18px; border:none; border-radius:10px; cursor:pointer;
      color:#fff; background:var(--primary);
    }
    #sendButton:hover{ background:var(--primary-2); }
    #sendButton:disabled{ background:#cfcfe9; cursor:not-allowed; }

    .typing-indicator{
      display:none; padding:8px 12px; background:#efeff8; color:#666; border-radius:10px; max-width:80%;
      font-style:italic;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <h1>🤖 Chatbot DDD</h1>
      <button class="reset-button" id="resetBtn">🔄 Reiniciar</button>
    </div>

    <div class="messages" id="messages">
      <div class="message bot-message">
        ¡Hola! Soy tu asistente DDD. ¿En qué puedo ayudarte?
      </div>
    </div>

    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." />
      <button id="sendButton">Enviar</button>
    </div>
  </div>

  <script>
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const resetBtn = document.getElementById('resetBtn');

    // Ajustes del parser Markdown
    marked.setOptions({
      breaks: true,    // trata líneas nuevas como <br>
      gfm: true
    });

    function renderMarkdown(md){
      const html = marked.parse(md || '');
      return DOMPurify.sanitize(html); // seguridad
    }

    // --- helpers de UI ---
    function addUserMessage(text){
      const d = document.createElement('div');
      d.className = 'message user-message';
      d.textContent = text;           // usuario: texto plano
      messagesDiv.appendChild(d);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    function addBotMessageMarkdown(md){
      const d = document.createElement('div');
      d.className = 'message bot-message';
      d.innerHTML = renderMarkdown(md);  // bot: Markdown -> HTML seguro
      messagesDiv.appendChild(d);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    function showTyping(){
      const tip = document.createElement('div');
      tip.id = 'typing';
      tip.className = 'typing-indicator';
      tip.textContent = 'Escribiendo...';
      tip.style.display = 'block';
      messagesDiv.appendChild(tip);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    function hideTyping(){
      const tip = document.getElementById('typing');
      if (tip) tip.remove();
    }

    // --- reset conversación ---
    async function resetConversation(){
      try{
        await fetch('/reset', { method: 'POST' });
      }catch(e){
        console.error('Error al reiniciar en backend', e);
      }
      // limpiar UI y estado local
      messagesDiv.innerHTML = '<div class="message bot-message">¡Hola! Soy tu asistente DDD. ¿En qué puedo ayudarte?</div>';
      messageInput.value = '';
      messageInput.focus();
    }

    // --- envío de mensaje ---
    async function sendMessage(){
      const message = messageInput.value.trim();
      if(!message) return;

      addUserMessage(message);
      messageInput.value = '';
      sendButton.disabled = true;
      showTyping();

      try{
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const data = await response.json();

        if(response.ok){
          addBotMessageMarkdown(data.response || '⚠️ El modelo no devolvió contenido.');
        }else{
          addBotMessageMarkdown('**Error:** ' + (data.error || 'No se pudo procesar el mensaje'));
        }
      }catch(err){
        console.error(err);
        addBotMessageMarkdown('**Error de conexión.** Intenta de nuevo.');
      }finally{
        hideTyping();
        sendButton.disabled = false;
        messageInput.focus();
      }
    }

    // eventos
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMessage(); });
    resetBtn.addEventListener('click', resetConversation);

    // foco inicial
    messageInput.focus();
  </script>
</body>
</html>
